{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="min-h-screen flex flex-col items-center justify-center px-6 py-10">
  <div class="max-w-5xl w-full bg-white shadow-2xl rounded-3xl overflow-hidden transition-all">

    <!-- Header -->
    <div class="bg-white border-b px-8 py-6 rounded-t-3xl flex justify-between items-center">
      <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
        {% if exam %}Edit{% else %}Create New{% endif %} Exam
      </h1>
      {% if exam %}
      <form method="post" action="{% url 'exams:send_grades' exam.id %}">
        {% csrf_token %}
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-md shadow-md flex items-center gap-2">
          <i data-lucide="send" class="w-4 h-4"></i> Send Grades
        </button>
      </form>
      {% endif %}
    </div>

    <!-- Exam Form -->
    <form method="post" action="{% if exam %}?edit={{ exam.id }}{% endif %}" class="pt-0 pb-8 px-8 space-y-6" id="examForm">
      {% csrf_token %}

      <!-- Exam Details -->
      <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mt-0">Exam Details</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="text-gray-700 text-base font-medium">Exam Name</label>
          <input type="text" name="exam_name" required placeholder="Enter exam title"
            value="{{ exam.name|default:'' }}"
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>

        <div>
          <label class="text-gray-700 text-base font-medium">Select Course</label>
          <select name="course" required
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <option value="">-- Select a Course --</option>
            {% for course in courses %}
            <option value="{{ course.id }}" {% if exam and exam.course.id == course.id %}selected{% endif %}>{{ course.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Marks & Time -->
      <div class="grid grid-cols-2 gap-6">
        <div>
          <label class="text-gray-700 text-base font-medium">Total Marks</label>
          <input type="number" id="total_marks" name="total_marks" required placeholder="Enter total marks"
            value="{{ exam.total_marks|default:'' }}"
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" readonly>
        </div>
        <div>
          <label class="text-gray-700 text-base font-medium">Exam Duration (Optional)</label>
          <input type="number" name="exam_time" placeholder="Time in minutes"
            value="{{ exam.duration_minutes|default:'' }}"
            class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>
      </div>

      <!-- Add Question Buttons -->
      <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mt-6">Add Questions</h2>
      <div class="flex flex-wrap gap-3">
        <button type="button" id="add_tf" class="flex-1 min-w-[130px] px-5 py-3 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-medium text-base transition">
          True/False
        </button>
        <button type="button" id="add_mcq" class="flex-1 min-w-[130px] px-5 py-3 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-medium text-base transition">
          MCQ
        </button>
        <button type="button" id="add_short" class="flex-1 min-w-[130px] px-5 py-3 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-medium text-base transition">
          Short Answer
        </button>
        <button type="button" id="add_long" class="flex-1 min-w-[130px] px-5 py-3 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-medium text-base transition">
          Long Answer
        </button>
      </div>

      <!-- Questions Container -->
      <div id="questions_container" class="mt-6 space-y-4">
        <!-- True/False Questions -->
        {% for q in questions_by_type.true_false %}
        <div class="question-block relative p-5 border border-gray-200 rounded-lg bg-blue-50">
          <button type="button" onclick="removeBlock(this)" class="absolute top-3 right-3 text-gray-400 hover:text-red-500">
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
          <label class="block text-sm font-medium text-gray-700 mb-1">True/False Question</label>
          <input type="text" name="tf_questions[]" value="{{ q.text }}" required class="w-full px-3 py-2 border rounded mb-2" placeholder="Enter question...">
          <select name="tf_answers[]" class="w-full px-3 py-2 border rounded mb-2" required>
            <option value="True" {% if q.correct_answer == "True" %}selected{% endif %}>True</option>
            <option value="False" {% if q.correct_answer == "False" %}selected{% endif %}>False</option>
          </select>
          <input type="number" name="tf_marks[]" value="{{ q.marks }}" required class="w-full px-3 py-2 border rounded" placeholder="Marks">
        </div>
        {% endfor %}

        <!-- MCQ Questions -->
        {% for q in questions_by_type.mcq %}
        <div class="question-block relative p-5 border border-gray-200 rounded-lg bg-green-50">
          <button type="button" onclick="removeBlock(this)" class="absolute top-3 right-3 text-gray-400 hover:text-red-500">
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
          <label class="block text-sm font-medium text-gray-700 mb-1">MCQ Question</label>
          <input type="text" name="mcq_questions[]" value="{{ q.text }}" required class="w-full px-3 py-2 border rounded mb-2" placeholder="Enter question...">
          <input type="text" name="mcq_options_1[]" value="{{ q.option_list.0 }}" placeholder="Option 1" required class="w-full px-3 py-2 border rounded mb-1">
          <input type="text" name="mcq_options_2[]" value="{{ q.option_list.1 }}" placeholder="Option 2" required class="w-full px-3 py-2 border rounded mb-1">
          <input type="text" name="mcq_options_3[]" value="{{ q.option_list.2 }}" placeholder="Option 3" required class="w-full px-3 py-2 border rounded mb-1">
          <input type="text" name="mcq_options_4[]" value="{{ q.option_list.3 }}" placeholder="Option 4" required class="w-full px-3 py-2 border rounded mb-2">
          <input type="text" name="mcq_answers[]" value="{{ q.correct_answer }}" placeholder="Correct Answer" required class="w-full px-3 py-2 border rounded mb-2">
          <input type="number" name="mcq_marks[]" value="{{ q.marks }}" required class="w-full px-3 py-2 border rounded" placeholder="Marks">
        </div>
        {% endfor %}

        <!-- Short Answer Questions -->
        {% for q in questions_by_type.short_answer %}
        <div class="question-block relative p-5 border border-gray-200 rounded-lg bg-purple-50">
          <button type="button" onclick="removeBlock(this)" class="absolute top-3 right-3 text-gray-400 hover:text-red-500">
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
          <label class="block text-sm font-medium text-gray-700 mb-1">Short Answer Question</label>
          <input type="text" name="short_questions[]" value="{{ q.text }}" required class="w-full px-3 py-2 border rounded mb-2" placeholder="Enter question...">
          <input type="text" name="short_correct_answer[]" value="{{ q.correct_answer }}" required class="w-full px-3 py-2 border rounded mb-2" placeholder="Correct Answer">
          <input type="number" name="short_marks[]" value="{{ q.marks }}" required class="w-full px-3 py-2 border rounded mb-2" placeholder="Marks">

          <!-- Evaluation Type -->
          <label class="text-sm font-medium text-gray-700">Evaluation Type</label>
          <select name="short_eval_type[]" class="eval-dropdown w-full px-3 py-2 border rounded mb-2">
            <option value="strict" {% if q.eval_type == 'strict' %}selected{% endif %}>Strict – Exact match required</option>
            <option value="flexible" {% if q.eval_type == 'flexible' %}selected{% endif %}>Flexible – Accept paraphrasing</option>
            <option value="keywords" {% if q.eval_type == 'keywords' %}selected{% endif %}>Keywords – Must mention key ideas</option>
            <option value="coding" {% if q.eval_type == 'coding' %}selected{% endif %}>Coding – Evaluate logic and syntax</option>
            <option value="custom" {% if q.eval_type == 'custom' %}selected{% endif %}>Custom – Use custom instructions</option>
          </select>

          <textarea name="short_custom_eval[]" class="custom-eval-area w-full px-3 py-2 border rounded text-sm text-gray-600 mb-2"
            placeholder="Custom grading instructions (only if Custom is selected)"
            {% if q.eval_type != 'custom' %}style="display:none;"{% endif %}>{{ q.custom_eval }}</textarea>
        </div>
        {% endfor %}

        <!-- Long Answer Questions -->
        {% for q in questions_by_type.long_answer %}
        <div class="question-block relative p-5 border border-gray-200 rounded-lg bg-red-50">
          <button type="button" onclick="removeBlock(this)" class="absolute top-3 right-3 text-gray-400 hover:text-red-500">
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
          <label class="block text-sm font-medium text-gray-700 mb-1">Long Answer Question</label>
          <input type="text" name="long_questions[]" value="{{ q.text }}" required class="w-full px-3 py-2 border rounded mb-2" placeholder="Enter question...">
          <input type="text" name="long_correct_answer[]" value="{{ q.correct_answer }}" required class="w-full px-3 py-2 border rounded mb-2" placeholder="Correct Answer">
          <input type="number" name="long_marks[]" value="{{ q.marks }}" required class="w-full px-3 py-2 border rounded mb-2" placeholder="Marks">

          <!-- Evaluation Type -->
          <label class="text-sm font-medium text-gray-700">Evaluation Type</label>
          <select name="long_eval_type[]" class="eval-dropdown w-full px-3 py-2 border rounded mb-2">
            <option value="strict" {% if q.eval_type == 'strict' %}selected{% endif %}>Strict – Exact match required</option>
            <option value="flexible" {% if q.eval_type == 'flexible' %}selected{% endif %}>Flexible – Accept paraphrasing</option>
            <option value="keywords" {% if q.eval_type == 'keywords' %}selected{% endif %}>Keywords – Check if key points mentioned</option>
            <option value="coding" {% if q.eval_type == 'coding' %}selected{% endif %}>Coding – Evaluate code output</option>
            <option value="custom" {% if q.eval_type == 'custom' %}selected{% endif %}>Custom – Use custom grading instructions</option>
          </select>

          <textarea name="long_custom_eval[]" class="custom-eval-area w-full px-3 py-2 border rounded text-sm text-gray-600 mb-2"
            placeholder="Custom grading instructions"
            {% if q.eval_type != 'custom' %}style="display:none;"{% endif %}>{{ q.custom_eval }}</textarea>
        </div>
        {% endfor %}


        <!-- Submit Button -->
        <button type="submit" class="w-full px-6 py-3 bg-[#1C304F] hover:bg-[#16263F] text-white text-base font-semibold rounded-lg shadow-md transition flex justify-center items-center gap-2">
            <i data-lucide="check" class="w-5 h-5"></i> Submit Exam
        </button>            
      </form>
    </div>
</div>

<script>
  // Handle Eval Dropdowns Once
  function attachEvalDropdownListeners(scope = document) {
    scope.querySelectorAll('.eval-dropdown').forEach(dropdown => {
      dropdown.addEventListener('change', function () {
        const textarea = this.nextElementSibling;
        textarea.style.display = this.value === 'custom' ? 'block' : 'none';
      });
  
      // Show on load if needed
      if (dropdown.value === 'custom') {
        dropdown.nextElementSibling.style.display = 'block';
      }
    });
  }
  attachEvalDropdownListeners();
  
  // Lucide Icons Refresh
  function refreshIcons() {
    if (window.lucide) {
      window.lucide.createIcons();
    }
  }
  
  // Remove Block
  function removeBlock(button) {
    const parentBtn = button.closest('button');
    const block = parentBtn.closest('.question-block');
    if (block) {
      block.remove();
      updateTotalMarks();
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    if (window.lucide) {
      lucide.createIcons();  
    }
  });

  
  // Update Total Marks
  function updateTotalMarks() {
    let total = 0;
    const markInputs = document.querySelectorAll('#questions_container input[name$="_marks[]"]');
    markInputs.forEach(input => {
      const val = parseFloat(input.value);
      if (!isNaN(val)) total += val;
    });
    document.getElementById('total_marks').value = total;
  }
  
  // Attach Input Listener
  function attachMarksListener(container) {
    container.querySelectorAll('input[name$="_marks[]"]').forEach(input => {
      input.addEventListener('input', updateTotalMarks);
    });
  }
  
  // Add Question Templates
  function createQuestionBlock(type, color, content) {
    const container = document.createElement('div');
    container.className = `question-block relative p-4 border rounded-xl ${color}`;
    container.innerHTML = `
      <button type="button" onclick="removeBlock(this)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
      ${content}
    `;
    document.getElementById('questions_container').appendChild(container);
    attachMarksListener(container);
    attachEvalDropdownListeners(container);
    updateTotalMarks();
    refreshIcons();
  }
  
  // Add True/False
  document.getElementById('add_tf').addEventListener('click', function() {
    createQuestionBlock('tf', 'bg-blue-50', `
      <label class="block text-sm font-medium text-gray-700 mb-1">True/False Question</label>
      <input type="text" name="tf_questions[]" required placeholder="Enter question..." class="w-full px-3 py-2 border rounded mb-2">
      <select name="tf_answers[]" class="w-full px-3 py-2 border rounded mb-2" required>
        <option value="True">True</option>
        <option value="False">False</option>
      </select>
      <input type="number" name="tf_marks[]" required placeholder="Marks" class="w-full px-3 py-2 border rounded">
    `);
  });
  
  // Add MCQ
  document.getElementById('add_mcq').addEventListener('click', function() {
    createQuestionBlock('mcq', 'bg-green-50', `
      <label class="block text-sm font-medium text-gray-700 mb-1">MCQ Question</label>
      <input type="text" name="mcq_questions[]" required placeholder="Enter question..." class="w-full px-3 py-2 border rounded mb-2">
      <input type="text" name="mcq_options_1[]" required placeholder="Option 1" class="w-full px-3 py-2 border rounded mb-1">
      <input type="text" name="mcq_options_2[]" required placeholder="Option 2" class="w-full px-3 py-2 border rounded mb-1">
      <input type="text" name="mcq_options_3[]" required placeholder="Option 3" class="w-full px-3 py-2 border rounded mb-1">
      <input type="text" name="mcq_options_4[]" required placeholder="Option 4" class="w-full px-3 py-2 border rounded mb-2">
      <input type="text" name="mcq_answers[]" required placeholder="Correct Answer" class="w-full px-3 py-2 border rounded mb-2">
      <input type="number" name="mcq_marks[]" required placeholder="Marks" class="w-full px-3 py-2 border rounded">
    `);
  });
  
  // Add Short Answer
  document.getElementById('add_short').addEventListener('click', function() {
    createQuestionBlock('short', 'bg-purple-50', `
      <label class="block text-sm font-medium text-gray-700 mb-1">Short Answer Question</label>
      <input type="text" name="short_questions[]" required placeholder="Enter question..." class="w-full px-3 py-2 border rounded mb-2">
      <input type="text" name="short_correct_answer[]" required placeholder="Correct Answer" class="w-full px-3 py-2 border rounded mb-2">
      <input type="number" name="short_marks[]" required placeholder="Marks" class="w-full px-3 py-2 border rounded mb-2">
      <label class="text-sm font-medium text-gray-700">Evaluation Type</label>
      <select name="short_eval_type[]" class="eval-dropdown w-full px-3 py-2 border rounded mb-2">
        <option value="strict">Strict – Exact match required</option>
        <option value="flexible">Flexible – Accept paraphrasing</option>
        <option value="keywords">Keywords – Must mention key ideas</option>
        <option value="coding">Coding – Evaluate logic and syntax</option>
        <option value="custom">Custom – Use custom instructions</option>
      </select>
      <textarea name="short_custom_eval[]" class="custom-eval-area w-full px-3 py-2 border rounded text-sm text-gray-600 mb-2"
        placeholder="Custom grading instructions (only if Custom is selected)" style="display:none;"></textarea>
    `);
  });
  
  // Add Long Answer
  document.getElementById('add_long').addEventListener('click', function() {
    createQuestionBlock('long', 'bg-red-50', `
      <label class="block text-sm font-medium text-gray-700 mb-1">Long Answer Question</label>
      <input type="text" name="long_questions[]" required placeholder="Enter question..." class="w-full px-3 py-2 border rounded mb-2">
      <input type="text" name="long_correct_answer[]" required placeholder="Correct Answer" class="w-full px-3 py-2 border rounded mb-2">
      <input type="number" name="long_marks[]" required placeholder="Marks" class="w-full px-3 py-2 border rounded mb-2">
      <label class="text-sm font-medium text-gray-700">Evaluation Type</label>
      <select name="long_eval_type[]" class="eval-dropdown w-full px-3 py-2 border rounded mb-2">
        <option value="strict">Strict – Exact match required</option>
        <option value="flexible">Flexible – Accept paraphrasing</option>
        <option value="keywords">Keywords – Check if key points mentioned</option>
        <option value="coding">Coding – Evaluate code output</option>
        <option value="custom">Custom – Use custom grading instructions</option>
      </select>
      <textarea name="long_custom_eval[]" class="custom-eval-area w-full px-3 py-2 border rounded text-sm text-gray-600 mb-2"
        placeholder="Custom grading instructions" style="display:none;"></textarea>
    `);
  });
</script>  

{% if deleted_questions_count %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const deletedQuestionsCount = parseInt("{{ deleted_questions_count|default:'0' }}");
    const alertBox = document.createElement('div');
    alertBox.className = 'fixed top-6 right-6 z-50 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded shadow';
    alertBox.innerHTML = `
  <div class="flex justify-between items-center">
    <div><strong>Heads up!</strong> ${deletedQuestionsCount} previously removed question${deletedQuestionsCount !== 1 ? 's' : ''} won’t appear here.</div>
    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-yellow-700 hover:text-red-600 font-bold">✖</button>
  </div>
`;
    document.body.appendChild(alertBox);
    setTimeout(() => alertBox.remove(), 7000);
  });
</script>
{% endif %}

{% endblock %}
