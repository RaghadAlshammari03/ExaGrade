{% extends 'base.html' %}
{% block content %}
<div id="examPage" data-exam-id="{{ exam.id }}">
<div class="max-w-8xl mx-auto bg-white shadow-xl rounded-2xl p-8 mt-10 transition-transform duration-300 ">

    <!-- Header -->
    <div class="flex justify-between items-center mb-8 flex-wrap gap-4">
        <h1 class="text-4xl font-bold text-gray-800 flex items-center gap-2">
            {{ exam.name }}
        </h1>
        <div class="flex items-center gap-3">
            <span class="px-4 py-1 text-sm font-semibold rounded-full 
                {% if exam.status == 'done' %} bg-green-500 
                {% elif exam.status == 'progress' %} bg-yellow-500 
                {% elif exam.status == 'pending' %} bg-gray-500 
                {% elif exam.status == 'requires_attention' %} bg-red-600
                {% elif exam.status == 'new_papers_uploaded' %} bg-orange-500  
                {% endif %} text-white">
                {{ exam.get_status_display }}
            </span>

            {% if user.is_instructor %}
            <form method="POST" action="{% url 'exams:send_grades' exam.id %}">
                {% csrf_token %}
                <button type="button"
                        onclick="openSendGradesModal()"
                        {% if not has_graded_papers %}
                            disabled
                            class="px-4 py-2 bg-blue-400 text-white rounded-lg cursor-not-allowed opacity-60"
                            title="Grade at least one paper before sending"
                        {% else %}
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        {% endif %}>
                    Send Grades
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- Exam Info -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="p-5 border rounded-xl bg-gray-50">
            <h2 class="text-xl font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <i data-lucide="book-open" class="w-5 h-5 text-gray-500"></i> Course
            </h2>
            <p class="text-gray-600">{{ exam.course.name }}</p>
        </div>

        <div class="p-5 border rounded-xl bg-gray-50 flex flex-col justify-between">
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-2 flex items-center gap-2">
                    <i data-lucide="calendar" class="w-5 h-5 text-gray-500"></i> Created At
                </h2>
                <p class="text-gray-600">{{ exam.created_at|date:"F j, Y - g:i A" }}</p>
            </div>
            {% if user.is_instructor %}
            <div class="flex flex-wrap gap-3 mt-5">
              <form method="POST" action="{% url 'exams:grade_exam' exam.id %}">
                {% csrf_token %}
                <button type="button"
                        onclick="startGrading(this)"
                        data-action="{{ grading_button_text|slugify }}"
                        data-mode="{% if grading_button_text == 'Regrade All' %}regrade{% elif grading_button_text == 'Grade New Papers' %}new{% else %}{% endif %}"
                  {% if student_papers|length == 0 %}
                      disabled
                      class="bg-blue-400 cursor-not-allowed opacity-60 text-white py-2 px-4 rounded-lg text-sm font-semibold shadow-md flex items-center gap-2"
                      title="Upload student papers to enable grading"
                  {% else %}
                      class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm font-semibold shadow-md flex items-center gap-2"
                  {% endif %}>
                    
                  {% if grading_button_text == "Regrade All" %}
                      <i class="text-white-400" data-lucide="refresh-cw" title="Regrade all papers"></i>
                  {% elif grading_button_text == "Grade New Papers" %}
                      <i class="text-white-500" data-lucide="plus-circle" title="Grade newly added papers"></i>
                  {% else %}
                      <i class="text-white" data-lucide="check-circle" title="Start grading"></i>
                  {% endif %}
                  <span>{{ grading_button_text }}</span>                         
                </button>
            </form>
                <a href="{% url 'exams:add' %}?edit={{ exam.id }}" class="inline-flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl shadow-md text-sm font-semibold">
                    <i data-lucide="edit" class="w-4 h-4"></i> Edit
                </a>
                <!-- Trigger Button -->
                <button onclick="openDeleteModal()" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg text-sm font-semibold shadow-md flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
                </button>

                <!-- Modal -->
                <div id="deleteModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-40 flex items-center justify-center">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 relative animate-fade-in-down">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Are you sure you want to delete this exam?</h3>
                        <p class="text-gray-600 mb-6">This action cannot be undone and will remove all related student papers and grades.</p>
                        <form method="POST" action="{% url 'exams:delete_exam' exam.id %}">
                            {% csrf_token %}
                            <p id="mergeErrorMessage" class="text-red-600 text-sm mb-4 hidden"></p>
                            <div class="flex justify-end gap-3">
                                <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm">Yes, Delete</button>
                            </div>
                        </form>
                        <button onclick="closeDeleteModal()" class="absolute top-3 right-4 text-gray-400 hover:text-red-500">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

            </div>
            {% endif %}
        </div>
    </div>

    <!-- Files -->
    <div class="mt-10">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <i data-lucide="folder-open" class="w-6 h-6"></i> Uploaded Files
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- Student Papers -->
            <div class="p-5 border rounded-xl bg-gray-50">
                <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2">
                    <i data-lucide="file" class="w-5 h-5 text-gray-500"></i> Student Papers
                    <span class="text-xs bg-gray-200 px-2 py-0.5 rounded-full text-gray-600">
                        {{ student_papers|length }} Uploaded
                    </span>
                </h3>

                <div class="mb-4 flex justify-between items-center flex-wrap gap-4">
                  <!-- Upload Button -->
                  <form id="uploadForm" enctype="multipart/form-data">
                      {% csrf_token %}
                      <label class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow cursor-pointer">
                          <i data-lucide="upload" class="w-4 h-4"></i> Upload More Papers
                          <input type="file" name="student_papers" multiple class="hidden" accept=".pdf,.jpg,.jpeg,.png" onchange="uploadPapers(this.files)">
                      </label>
                  </form>
              
                  <!-- Delete All Button -->
                  {% if student_papers %}
                  <button onclick="openDeleteAllModal()" class="text-red-600 hover:text-red-800 flex items-center gap-2 text-sm font-semibold">
                      <i data-lucide="trash-2" class="w-4 h-4"></i> Delete All Papers
                  </button>
                  {% endif %}
              </div>            

              <div class="student-papers-container">
                {% for paper in student_papers %}
                <div class="flex justify-between items-center p-4 bg-white border rounded-xl shadow-sm hover:shadow-md transition">
                    <div>
                        <p class="font-semibold text-gray-800">Paper #{{ forloop.counter }}</p>
                        <a href="{{ paper.file.url }}" target="_blank" class="text-blue-600 hover:underline text-sm truncate max-w-xs inline-block">
                            {{ paper.file.name|cut:'exams/student_papers/' }}
                        </a>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-500">{{ paper.uploaded_at|date:"M d, Y - h:i A" }}</span>
                        <button onclick="openDeletePaperModal('{{ paper.id }}')" class="text-red-500 hover:text-red-700 transition">
                            <i data-lucide="trash" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                {% empty %}
                <p class="text-sm text-gray-500">No student papers uploaded yet.</p>
                {% endfor %}
            </div>
          </div>

            <!-- Solution Module -->
            <div class="p-5 border rounded-xl bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5 text-gray-500"></i> Solution Module
                </h3>
                {% if exam.solution_module %}
                    <a href="{{ exam.solution_module.url }}" target="_blank" class="text-green-600 hover:underline flex items-center gap-1">
                        <i data-lucide="download" class="w-4 h-4"></i> View / Download
                    </a>
                {% endif %}
                <form method="POST" action="{% url 'exams:generate_exam_pdf' exam.id %}">
                    {% csrf_token %}
                    <button type="submit" class="mt-3 px-4 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 flex items-center gap-2">
                        <i data-lucide="printer" class="w-4 h-4"></i> Generate Exam PDF
                    </button>
                </form>
                <form method="POST" action="{% url 'exams:generate_answered_pdf' exam.id %}">
                    {% csrf_token %}
                    <button type="submit" class="mt-3 px-4 py-2 bg-amber-600 text-white rounded-lg shadow-md hover:bg-amber-700 flex items-center gap-2">
                        <i data-lucide="file-text" class="w-4 h-4"></i> Download Answered Module
                    </button>
                </form>                
            </div>
        </div>
    </div>

    <div class="mt-10">
    <h2 class="text-2xl font-semibold text-gray-800 flex items-center gap-2">
      <i data-lucide="bar-chart" class="w-6 h-6"></i> Student Performance Overview
   </h2>

    <!-- Grades Distribution Chart -->
    <div class="bg-gray-50 rounded-xl p-6 shadow-md border mt-4">
      <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
          <i data-lucide="bar-chart-3" class="w-5 h-5 text-gray-500"></i> Grade Distribution
      </h2>
      <div class="w-full h-[400px]">
          <canvas id="gradesDistributionChart" class="w-full h-full"></canvas>
      </div>
  </div>  

    <!-- Student Performance Overview Table -->
    <div class="mt-10">
      <div class="flex flex-wrap items-center justify-between gap-4 mb-4 mt-4">
        <!-- 🔍 Search Input -->
        <input id="searchInput" type="text" placeholder="Search by name or ID..." class="border border-gray-300 px-3 py-1.5 rounded-md text-sm focus:ring focus:border-blue-400" />
      
        <!-- 🏷️ Badge Filter Dropdown -->
        <select id="badgeFilterDropdown" onchange="applyBadgeFilter()" class="border border-gray-300 px-3 py-1.5 rounded-md text-sm text-gray-700 focus:ring focus:border-blue-400">
          <option value="all">Filter by Status</option>
          <option value="Ungraded">Ungraded</option>
          <option value="Enrolled">Enrolled</option>
          <option value="Not Enrolled">Not Enrolled</option>
          <option value="⚠️ Review Needed">⚠️ Review Needed</option>
          <option value="Merged">Merged</option>
        </select>
      </div>   
        
      <div class="overflow-x-auto rounded-lg shadow border">
        <table id="gradesTable" class="min-w-full border bg-white text-sm">      
              <thead class="bg-white border-b">
                <tr class="bg-gray-100 text-left text-sm text-gray-700">
                  <th class="py-3 px-4 text-center"></th>
                  <th class="py-3 px-6">Student</th>
                  <th class="py-3 px-6">ID</th>
                  <th class="py-3 px-6 text-center">Grade</th>
                  <th class="py-3 px-6 text-center">File</th>
                  <th class="py-3 px-6 text-center">Extracted</th>
                  <th class="py-3 px-6 text-center">AI Feedback</th>
                  <th class="py-3 px-6">Instructor Feedback</th>
                  <th class="py-3 px-6 text-center">Actions</th>
                </tr>
              </thead>              
                <tbody>
                  {% for paper in paper_data %}
                    <tr class="border-t hover:bg-gray-50">
                      <td class="py-3 px-4 text-center">
                        {% if paper.merged_files or not paper.paper.merged_into %}
                          <input type="checkbox" name="paper_ids" value="{{ paper.id }}" 
                                 class="merge-checkbox" 
                                 data-student-id="{{ paper.student_id }}">
                        {% else %}
                          — 
                        {% endif %}
                      </td>                                            

                        <!-- Student Name -->
                        <td class="py-3 px-6 font-medium student-name text-gray-800">
                          <span id="studentName-{{ paper.id }}" class="flex items-center gap-1">
                              {{ paper.student_name }}
                          </span>

                          <!-- Badges: Ungraded, Missing Info, Requires Attention, Enrolled, etc -->
                          <div class="badge-filtered flex flex-wrap gap-1 mt-1">
                            {% for badge in paper.badges %}
                              <span class="text-xs font-semibold px-2 py-0.5 rounded {{ badge.style }}">
                                {{ badge.text }}
                              </span>
                            {% endfor %}
                          </div>       

                          {% if user.is_instructor %}
                              <button onclick="toggleNameEdit('{{ paper.id }}')" class="ml-2 text-blue-600 hover:text-blue-800" title="Edit Name">
                                  <i data-lucide="edit-3" class="w-4 h-4"></i>
                              </button>

                              <div id="editNameBox-{{ paper.id }}" class="hidden mt-1 flex gap-2">
                                  <span id="confirmName-{{ paper.id }}" class="text-green-600 text-sm hidden">✅</span>
                                  <input id="nameInput-{{ paper.id }}" type="text" class="text-sm border px-2 py-1 rounded" value="{{ paper.student_name }}">
                                  <button onclick="submitNameChange('{{ paper.id }}')" class="bg-blue-600 text-white px-3 py-1 text-sm rounded hover:bg-blue-700">Save</button>
                                  <button onclick="toggleNameEdit('{{ paper.id }}')" class="text-gray-500 text-sm hover:text-red-600">Cancel</button>
                              </div>
                          {% endif %}
                        </td>

                        <!-- Student ID -->
                        <td class="py-3 px-6 text-sm text-gray-600">
                            <span id="studentId-{{ paper.id }}">
                              {{ paper.student_id|default:"—" }}
                            </span>
                            {% if paper.manual_id %}
                              {% if user.is_instructor %}
                              {% if paper.is_merged %}
                                <form method="POST" action="{% url 'exams:unmerge_papers' exam.id %}" class="inline-block ml-2">
                                  {% csrf_token %}
                                  <input type="hidden" name="student_id" value="{{ paper.manual_id }}">
                                  <button type="submit" class="text-red-600 text-xs hover:underline">Unmerge</button>
                                </form>
                                <span class="ml-1 text-xs text-white bg-purple-500 px-2 py-0.5 rounded-full">Merged</span>
                              {% endif %}
                              {% endif %}
                            {% endif %}

                            {% if user.is_instructor %}
                            <button onclick="toggleIdEdit('{{ paper.id }}')" class="ml-2 text-blue-600 hover:text-blue-800" title="Edit ID">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>

                            <div id="editIdBox-{{ paper.id }}" class="hidden mt-1 flex flex-col gap-2">
                                <div class="flex gap-2">
                                    <input id="idInput-{{ paper.id }}" type="text" inputmode="numeric" class="text-sm border px-2 py-1 rounded w-28" value="{{ paper.student_id }}">
                                    <button onclick="submitIdChange('{{ paper.id }}')" class="bg-blue-600 text-white px-3 py-1 text-sm rounded hover:bg-blue-700">Save</button>
                                    <button onclick="toggleIdEdit('{{ paper.id }}')" class="text-gray-500 text-sm hover:text-red-600">Cancel</button>
                                </div>
                                <!-- Success / Error Message -->
                                <span id="confirmId-{{ paper.id }}" class="text-green-600 text-sm hidden">✅ Saved</span>
                                <span id="errorId-{{ paper.id }}" class="text-red-600 text-sm hidden">❌ Please enter a valid numeric ID.</span>
                            </div>                            
                            {% endif %}
                        </td>
                       
                        <!-- Grade + Override + Feedback Toggle -->
                        <td class="py-3 px-6 text-center grade-cell">
                            <div class="text-sm">
                                <strong>Score:</strong>
                                {% if paper.manual_override %}
                                    {{ paper.manual_override }} <span class="text-xs text-yellow-600">(Manual)</span>
                                {% else %}
                                    {{ paper.grade }}
                                {% endif %}
                            </div>

                            <!-- Toggle Manual Override -->
                            <div>
                                <button type="button"
                                    onclick="toggleOverride('{{ paper.id }}')"
                                    class="flex items-center gap-1 text-xs text-blue-600 hover:text-blue-700 font-medium transition hover:underline">
                                    <i data-lucide="edit-3" class="w-4 h-4"></i>
                                </button>

                                <div id="overrideBox-{{ paper.id }}" class="override-wrapper hidden">
                                    <div class="space-y-1 override-form" data-total="{{ exam.total_marks }}">
                                        <label class="block text-xs font-medium text-gray-700">Manual Override</label>
                                        <input id="manualInput-{{ paper.id }}" class="override-input text-sm border px-2 py-1 rounded w-24" type="number" step="0.01" required>

                                        <p class="text-xs text-red-500 error-message hidden">Please enter a valid number ≤ {{ exam.total_marks }}.</p>

                                        <div class="flex items-center gap-2 mt-1">
                                            <button type="button" onclick="submitGradeOverride('{{ paper.id }}', '{{ exam.id }}')" class="bg-blue-600 text-white px-3 py-1 text-sm rounded hover:bg-blue-700">Save</button>
                                            <button type="button" onclick="cancelOverride('{{ paper.id }}')" class="text-xs text-gray-600 hover:text-red-500">Cancel</button>
                                            <span id="confirmGrade-{{ paper.id }}" class="text-green-600 text-sm hidden">✅</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>

                        <!-- View File Column -->
                        <td class="py-3 px-6 text-left">
                          <details class="group">
                            <summary class="cursor-pointer text-sm font-medium text-blue-600 hover:underline flex items-center gap-2">
                              <i data-lucide="folder-open" class="w-4 h-4"></i> View Papers
                            </summary>
                            <div class="mt-2 space-y-2 pl-6">
                              {% for file in paper.merged_files %}
                              <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-700">{{ file.label }}:</span>
                                <a href="{{ file.url }}" target="_blank"
                                  class="inline-flex items-center gap-1 bg-gray-100 hover:bg-gray-200 text-sm px-3 py-1 rounded-lg shadow">
                                  <i data-lucide="eye" class="w-4 h-4"></i> View
                                </a>
                              </div>
                              {% endfor %}
                            </div>
                          </details>
                        </td>                        

                        <!-- Extracted Text Column -->
                        <td class="py-3 px-6 text-left">
                          <details class="group">
                            <summary class="cursor-pointer text-sm font-medium text-blue-600 hover:underline flex items-center gap-2">
                              <i data-lucide="eye" class="w-4 h-4"></i> View Extracted
                            </summary>
                            <div class="mt-2 space-y-2 pl-6">
                              {% for file in paper.merged_extracts %}
                              <div class="flex items-center gap-2">
                                <span class="text-sm text-gray-700">{{ file.label }}:</span>
                                <button onclick="toggleTextModal('merged-{{ file.id }}')"
                                  class="inline-flex items-center gap-1 bg-gray-100 hover:bg-gray-200 text-sm px-3 py-1 rounded-lg shadow">
                                  <i data-lucide="eye" class="w-4 h-4"></i> View Extracted
                                </button>
                              </div>
                              {% endfor %}
                            </div>
                          </details>
                        </td>

                        <!-- AI Feedback -->
                        <td class="py-3 px-6 text-center align-middle">
                          <div class="flex justify-center">
                            <button onclick="openFeedbackModal('{{ paper.id }}')"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 text-sm font-medium rounded-lg shadow flex items-center gap-2">
                              <i data-lucide="message-circle" class="w-4 h-4"></i> View Feedback
                            </button>
                          </div>
                        </td>                        

                        <!-- Instructor Manual Feedback -->
                        <td class="py-3 px-6 text-sm text-gray-700 max-w-xs">
                            {% if user.is_instructor %}
                            <div id="staticFeedback-{{ paper.id }}" class="flex items-center">
                              <p class="truncate max-w-[220px]">{{ paper.instructor_feedback|default:"—" }}</p>
                              <button onclick="toggleFeedbackEdit('{{ paper.id }}')" class="text-blue-600 hover:text-blue-800 ml-3" title="Edit Feedback">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                              </button>
                            </div>                            
                          
                              <div id="feedbackEditBox-{{ paper.id }}" class="hidden space-y-2">
                                <textarea id="feedbackInput-{{ paper.id }}" class="border px-3 py-1.5 rounded w-full text-sm resize-none focus:ring focus:border-blue-500 transition" rows="2" placeholder="Write feedback...">{{ paper.instructor_feedback }}</textarea>
                                <div class="flex items-center gap-2">
                                  <button onclick="submitInstructorFeedback('{{ paper.id }}')" class="flex items-center gap-1 bg-blue-600 text-white px-3 py-1 text-sm rounded hover:bg-blue-700">
                                    <i data-lucide="save" class="w-4 h-4"></i> Save
                                  </button>
                                  <button onclick="clearInstructorFeedback('{{ paper.id }}')" class="flex items-center gap-1 text-red-600 hover:text-red-700 text-sm">
                                    <i data-lucide="eraser" class="w-4 h-4"></i> Clear
                                  </button>
                                  <button onclick="toggleFeedbackEdit('{{ paper.id }}')" class="text-xs text-gray-600 hover:text-red-500">Cancel</button>
                                  <span id="feedbackConfirm-{{ paper.id }}" class="text-green-600 text-sm hidden">✅</span>
                                </div>
                              </div>
                            {% else %}
                              <p>{{ paper.instructor_feedback|default:"—" }}</p>
                            {% endif %}
                          </td> 
                          
                          <!-- Grade Individually Button -->
                          {% if user.is_instructor %}
                          <td class="py-3 px-6 text-center">
                            <form method="POST" action="{% url 'exams:grade_one_student' exam.id paper.id %}">
                              {% csrf_token %}
                              <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 text-sm rounded shadow flex items-center gap-1">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Grade
                              </button>
                            </form>
                            {% endif %}
                          </td>
                      </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% for paper in paper_data %}
            {% for file in paper.merged_extracts %}
              <div id="textModalmerged-{{ file.id }}" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
                <div class="bg-white rounded-xl p-6 shadow-xl max-w-3xl w-full relative">
                  <button onclick="toggleTextModal('merged-{{ file.id }}')" class="absolute top-3 right-4 text-gray-400 hover:text-red-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                  </button>
                  <h2 class="text-xl font-bold text-gray-800 mb-4">🧠 Extracted Text ({{ file.label }})</h2>
                  <div class="overflow-y-auto max-h-[65vh] text-gray-700 whitespace-pre-wrap text-sm">
                    {{ file.text|default:"No extracted text available." }}
                  </div>
                </div>
              </div>
            {% endfor %}
          {% endfor %}
        </div>
    </div>
    </div>

    {% for paper in student_papers %}
<div id="flagPopup-{{ paper.id }}" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-2xl shadow-lg w-full max-w-2xl relative">
    <button onclick="closeFlagPopup('{{ paper.id }}')" class="absolute top-3 right-4 text-gray-500 hover:text-red-500">
      <i data-lucide="x" class="w-5 h-5"></i>
    </button>
    <h3 class="text-xl font-bold mb-4 text-red-600">🚨 Flagged Questions</h3>

    {% for issue in paper.flagged_issues.all %}
    <div class="mb-6 border-l-4 border-red-500 pl-4">
      <p><strong>Question:</strong> {{ issue.question.text }}</p>
      <p><strong>Student Answer:</strong> {{ issue.flagged_text|linebreaksbr }}</p>

      <form method="POST" action="{% url 'exams:resolve_flag' issue.id %}" class="mt-2">
        {% csrf_token %}
        <label class="text-sm">Assign Manual Grade (out of {{ issue.question.marks }}):</label>
        <input type="number" name="manual_score" max="{{ issue.question.marks }}" step="0.01" required class="border p-1 rounded text-sm w-32">
        <button type="submit" class="ml-2 bg-blue-600 text-white px-3 py-1 rounded text-sm">Save</button>
      </form>
    </div>
    {% endfor %}
  </div>
</div>
{% endfor %}
</div>
</div>

<div id="sendGradesModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl p-6 relative">
      <button onclick="closeSendGradesModal()" class="absolute top-3 right-4 text-gray-400 hover:text-red-500">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
      
      <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
        <i data-lucide="send" class="w-5 h-5 text-blue-600"></i> Send Results to Students
      </h2>
  
      <form method="POST" action="{% url 'exams:send_grades' exam.id %}">
        {% csrf_token %}
  
        <!-- Options to send -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            {% for opt in send_options %}
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" name="send_options" value="{{ opt|lower|slugify }}" class="rounded text-blue-600" checked>
            {{ opt }}
          </label>
          {% endfor %}
        </div>
  
        <!-- Student List -->
        <div class="mb-4 border rounded-xl p-4 max-h-64 overflow-y-auto bg-gray-50">
            <div class="flex items-center justify-between mb-2 text-sm">
            <strong>Students Matching Name and ID</strong>
            <div>
                <button type="button" onclick="selectAllStudents()" class="text-blue-600 hover:underline mr-3">Select All</button>
                <button type="button" onclick="deselectAllStudents()" class="text-red-600 hover:underline">Unselect All</button>
            </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              {% for paper in paper_data %}
              {% if paper.is_enrolled_and_matched and paper.grade != "not graded yet" %}            
                  <label class="flex items-center gap-2 text-sm bg-white p-2 rounded shadow-sm">
                    <input type="checkbox" name="student_ids" value="{{ paper.id }}" class="student-checkbox" checked>
                    {{ paper.student_name }} (ID: {{ paper.student_id }})
                  </label>
                {% endif %}
              {% endfor %}
            </div>
        </div>  

        <!-- Unmatched Students -->
        {% with unmatched_ids=request.session.unmatched_ids %}
          {% if unmatched_ids %}
          <div class="mt-6 border-t pt-4">
            <h3 class="text-sm font-semibold text-red-600 mb-2">Students Not Matched (Check Name or ID)</h3>
            <ul class="text-sm text-gray-700 space-y-1 max-h-40 overflow-y-auto">
              {% for paper in student_papers %}
                {% if paper.id|stringformat:"s" in unmatched_ids %}
                  <li class="bg-white p-2 rounded shadow-sm">
                    {{ paper.manual_name|default:"—" }} (ID: {{ paper.manual_id|default:"—" }})
                  </li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
          {% endif %}
          {% endwith %}
       
        <p class="text-sm text-gray-500 mb-4">Selected <span id="selectedCount">{{ student_papers|length }}</span> of {{ student_papers|length }} students.</p>
  
        <!-- Submit -->
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeSendGradesModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-sm rounded-lg">Cancel</button>
          {% if not has_graded_papers %}
            <button type="submit" id="sendGradesButton"
              disabled
              class="px-5 py-2 bg-blue-400 text-white rounded-lg text-sm font-semibold flex items-center gap-2 cursor-not-allowed opacity-50"
              title="You must grade at least one paper to send results">
              <i data-lucide="send" class="w-4 h-4"></i> Send Now
            </button>
          {% else %}
            <button type="submit" id="sendGradesButton"
              class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold flex items-center gap-2">
              <i data-lucide="send" class="w-4 h-4"></i> Send Now
            </button>
          {% endif %}      
        </div>
      </form>
    </div>
  </div>

<!-- DELETE PAPER MODAL -->
<div id="deletePaperModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-40 flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 relative animate-fade-in-down">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Are you sure you want to delete this student paper?</h3>
      <p class="text-gray-600 mb-6">This will remove the paper, extracted text, grades, and feedback. This action cannot be undone.</p>
      
      <form method="POST" id="deletePaperForm">
        {% csrf_token %}
        <div class="flex justify-end gap-3">
          <button type="button" onclick="closeDeletePaperModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-sm">Yes, Delete</button>
        </div>
      </form>
  
      <button onclick="closeDeletePaperModal()" class="absolute top-3 right-4 text-gray-400 hover:text-red-500">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
  </div>

  <!-- Confirm Merge Modal -->
<div id="confirmMergeModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md relative">
    <h3 class="text-xl font-bold text-gray-800 mb-2">Merge Selected Papers?</h3>
    <p class="text-gray-600 mb-6">This will merge the selected student papers into one group. Grading will be reset.</p>
    <div class="flex justify-end gap-3">
      <button onclick="closeMergeModal()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
      <button onclick="confirmMergeNow()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Yes, Merge</button>
    </div>
    <button onclick="closeMergeModal()" class="absolute top-3 right-4 text-gray-400 hover:text-red-500">
      <i data-lucide="x" class="w-5 h-5"></i>
    </button>
  </div>
</div>

<!-- Confirm Unmerge Modal -->
<div id="confirmUnmergeModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md relative">
    <h3 class="text-xl font-bold text-gray-800 mb-2">Unmerge Paper?</h3>
    <p class="text-gray-600 mb-6">This will split the group and reset grading for the merged paper.</p>
    <div class="flex justify-end gap-3">
      <button onclick="closeUnmergeModal()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
      <button onclick="confirmUnmergeNow()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Yes, Unmerge</button>
    </div>
    <button onclick="closeUnmergeModal()" class="absolute top-3 right-4 text-gray-400 hover:text-red-500">
      <i data-lucide="x" class="w-5 h-5"></i>
    </button>
  </div>
</div>

<!-- Name Conflict Modal -->
<div id="nameConflictModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md relative">
    <h3 class="text-xl font-bold text-gray-800 mb-2">Name Conflict Detected</h3>
    <p class="text-gray-600 mb-4">The selected papers have different names. Please choose the correct student name or enter a custom one:</p>

    <form id="resolveNameForm">
      <input type="hidden" id="conflictExamId">
      <input type="hidden" id="conflictPaperIds">

      <div class="space-y-2 mb-4" id="nameOptionsList">
        <!-- Options are dynamically inserted here -->
      </div>

      <!-- Optional custom name input -->
      <div class="mb-4">
        <label for="customNameInput" class="block text-sm font-medium text-gray-700 mb-1">Or enter a custom name:</label>
        <input type="text" id="customNameInput" name="custom_name"
            class="border px-3 py-1.5 rounded w-full text-sm focus:ring focus:border-blue-500"
            placeholder="Type custom name here..." disabled>
      </div>

      <div class="flex justify-end gap-3">
        <button type="button" onclick="closeNameConflictModal()"
                class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
        <button type="submit"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Merge</button>
      </div>
    </form>

    <button onclick="closeNameConflictModal()" class="absolute top-3 right-4 text-gray-400 hover:text-red-500">
      <i data-lucide="x" class="w-5 h-5"></i>
    </button>
  </div>
</div>

    
  <!--  Preline Loading Modal -->
<div id="progressModal" class="hs-overlay hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 text-center">
      <div class="mx-auto animate-spin rounded-full h-10 w-10 border-4 border-blue-500 border-t-transparent mb-4"></div>
      <h3 id="progressTitle" class="text-xl font-bold text-gray-800">Processing...</h3>
      <p id="progressCount" class="text-sm text-gray-600 mt-2">0 / 0</p>
    </div>
</div>

<!-- Floating Merge/Unmerge FAB -->
<div id="mergeFab" class="fixed bottom-6 right-6 z-40 hidden">
  <div class="flex flex-col gap-3">

    <!-- Merge Button with Label -->
    <button onclick="mergeSelectedPapers()" 
            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2">
      <i data-lucide="git-merge" class="w-5 h-5"></i>
      <span class="font-medium text-sm">Merge Papers</span>
    </button>

    <!-- Unmerge Button with Label -->
    <button onclick="unmergePaper()" 
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2">
      <i data-lucide="git-pull-request" class="w-5 h-5"></i>
      <span class="font-medium text-sm">Unmerge Paper</span>
    </button>

  </div>
</div>

<div id="feedbackModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white w-full max-w-3xl rounded-xl p-6 shadow-xl relative">
    <button onclick="closeFeedbackModal()" class="absolute top-3 right-4 text-gray-400 hover:text-red-600">
      <i data-lucide="x" class="w-5 h-5"></i>
    </button>

    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
      <i data-lucide="message-circle" class="w-5 h-5 text-blue-600"></i> AI Feedback
    </h2>

    <div id="feedbackContent" class="space-y-4 max-h-[60vh] overflow-y-auto"></div>
  </div>
</div>


<!-- Delete All Papers Confirmation Modal -->
<div id="deleteAllModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-40 flex items-center justify-center">
  <div class="bg-white rounded-2xl shadow-xl p-6 max-w-md w-full relative">
    <h3 class="text-xl font-bold text-red-600 mb-3">Delete All Papers?</h3>
    <p class="text-sm text-gray-600 mb-4">
      This will permanently delete <strong>all uploaded student papers</strong> for this exam. Are you sure?
    </p>
    <form id="deleteAllForm" method="POST">
      {% csrf_token %}
      <div class="flex justify-end gap-3 mt-4">
        <button type="button" onclick="closeDeleteAllModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-sm rounded-lg">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 text-sm rounded-lg">Yes, Delete All</button>
      </div>
    </form>
    <button onclick="closeDeleteAllModal()" class="absolute top-3 right-4 text-gray-400 hover:text-red-500">
      <i data-lucide="x" class="w-5 h-5"></i>
    </button>
  </div>
</div>

<!-- Toast Message -->
<div id="toastSuccess" class="fixed bottom-6 right-6 z-50 hidden bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg transition-all duration-300">
    <span id="toastMessage">✅ Operation complete</span>
  </div>


  <!-- Chart.js (for the graph) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Flatpickr (for date filtering – optional if you use a date range input) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    function toggleTextModal(id) {
    const modal = document.getElementById('textModal' + id);
    if (modal) {
        modal.classList.toggle('hidden');
    }
}


    document.getElementById("searchInput").addEventListener("keyup", function () {
    const query = this.value.toLowerCase();

    document.querySelectorAll("#gradesTable tbody tr").forEach(row => {
        const name = row.querySelector(".student-name").textContent.toLowerCase();
        const id = row.querySelector("td:nth-child(3)").textContent.toLowerCase(); // ID is the 2nd <td>
        row.style.display = name.includes(query) || id.includes(query) ? "" : "none";
    });
});

    let sortAsc = true;
    function sortTable(colIndex) {
        const table = document.getElementById("gradesTable");
        const rows = Array.from(table.tBodies[0].rows);
        rows.sort((a, b) => {
            const aText = a.cells[colIndex].textContent.trim();
            const bText = b.cells[colIndex].textContent.trim();
            return sortAsc
                ? aText.localeCompare(bText, undefined, { numeric: true })
                : bText.localeCompare(aText, undefined, { numeric: true });
        });
        sortAsc = !sortAsc;
        rows.forEach(row => table.tBodies[0].appendChild(row));
    }

    window.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".grade-cell").forEach(cell => {
            const grade = parseFloat(cell.textContent);
            if (!isNaN(grade)) {
                if (grade >= 85) {
                    cell.classList.add("text-green-600", "font-bold");
                } else if (grade >= 60) {
                    cell.classList.add("text-yellow-600", "font-semibold");
                } else {
                    cell.classList.add("text-red-600", "font-semibold");
                }
            }
        });
    });

    function openDeleteModal() {
        document.getElementById("deleteModal").classList.remove("hidden");
    }

    function closeDeleteModal() {
        document.getElementById("deleteModal").classList.add("hidden");
    }

    function toggleTextModal(counter) {
        const modal = document.getElementById('textModal' + counter);
        modal.classList.toggle('hidden');
    }

function toggleNameEdit(paperId) {
    document.getElementById("editNameBox-" + paperId).classList.toggle("hidden");
}

function submitNameChange(paperId) {
    const input = document.getElementById("nameInput-" + paperId);
    const newName = input.value;

    fetch(`/exams/${paperId}/edit-name/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": '{{ csrf_token }}',
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `name=${encodeURIComponent(newName)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById("studentName-" + paperId).innerText = newName;
            toggleNameEdit(paperId);
            document.getElementById("confirmName-" + paperId).classList.remove("hidden");
            setTimeout(() => document.getElementById("confirmName-" + paperId).classList.add("hidden"), 2000);
        } else {
            alert("❌ " + data.error);
        }
    });
}

function toggleIdEdit(paperId){
    document.getElementById("editIdBox-" + paperId).classList.toggle("hidden");
}

function submitIdChange(paperId) {
    const input = document.getElementById("idInput-" + paperId);
    const newId = input.value.trim();
    const confirmMsg = document.getElementById("confirmId-" + paperId);
    const errorMsg = document.getElementById("errorId-" + paperId);

    if (!/^\d+$/.test(newId)) {
        errorMsg.classList.remove("hidden");
        confirmMsg.classList.add("hidden");
        return;
    }

    errorMsg.classList.add("hidden"); // Hide error
    fetch(`/exams/${paperId}/edit-id/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": '{{ csrf_token }}',
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `student_id=${encodeURIComponent(newId)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById("studentId-" + paperId).innerText = newId;
            toggleIdEdit(paperId);
            confirmMsg.textContent = "✅ Saved";
            confirmMsg.classList.remove("hidden");
            setTimeout(() => confirmMsg.classList.add("hidden"), 2000);
        } else {
            errorMsg.textContent = "❌ " + data.error;
            errorMsg.classList.remove("hidden");
        }
    });
}


function toggleOverride(paperId) {
    const box = document.getElementById("overrideBox-" + paperId);
    if (box) box.classList.toggle("hidden");
}

function cancelOverride(paperId) {
    const box = document.getElementById("overrideBox-" + paperId);
    if (box) box.classList.add("hidden");
}

function submitGradeOverride(paperId, examId) {
    const input = document.getElementById("manualInput-" + paperId);
    const value = parseFloat(input.value);
    const total = parseFloat(document.querySelector(`#overrideBox-${paperId} .override-form`).dataset.total);
    const errorMsg = document.querySelector(`#overrideBox-${paperId} .error-message`);

    if (isNaN(value) || value > total || value < 0) {
        errorMsg.classList.remove("hidden");
        return;
    }

    errorMsg.classList.add("hidden");

    fetch(`/exams/${examId}/override/${paperId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": '{{ csrf_token }}',
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `manual_override=${encodeURIComponent(value)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const row = document.querySelector(`#studentName-${paperId}`).closest("tr");
            const gradeCell = row.querySelector(".grade-cell > div");
            gradeCell.innerHTML = `<strong>Score:</strong> ${value} <span class="text-xs text-yellow-600">(Manual)</span>`;
            document.getElementById("confirmGrade-" + paperId).classList.remove("hidden");
            setTimeout(() => {
                document.getElementById("confirmGrade-" + paperId).classList.add("hidden");
            }, 2000);
            document.getElementById("overrideBox-" + paperId).classList.add("hidden");
        } else {
            alert("❌ " + data.error);
        }
    });
}

function openFlagPopup(id) {
  document.getElementById("flagPopup-" + id).classList.remove("hidden");
}
function closeFlagPopup(id) {
  document.getElementById("flagPopup-" + id).classList.add("hidden");
}

function openDeletePaperModal(paperId) {
  const modal = document.getElementById("deletePaperModal");
  const form = document.getElementById("deletePaperForm");
  form.action = `/exams/paper/delete/${paperId}/`;  
  modal.classList.remove("hidden");
}

function closeDeletePaperModal() {
  document.getElementById("deletePaperModal").classList.add("hidden");
}


function toggleFeedbackEdit(paperId) {
  document.getElementById("staticFeedback-" + paperId).classList.toggle("hidden");
  document.getElementById("feedbackEditBox-" + paperId).classList.toggle("hidden");
}

function submitInstructorFeedback(paperId) {
  const feedback = document.getElementById("feedbackInput-" + paperId).value;

  fetch(`/exams/save-feedback/${paperId}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": '{{ csrf_token }}',
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: `feedback=${encodeURIComponent(feedback)}`
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      document.querySelector(`#staticFeedback-${paperId} p`).innerText = feedback || "—";
      document.getElementById("feedbackEditBox-" + paperId).classList.add("hidden");
      document.getElementById("staticFeedback-" + paperId).classList.remove("hidden");
      const confirm = document.getElementById("feedbackConfirm-" + paperId);
      confirm.textContent = "✅ Saved";
      confirm.classList.remove("hidden");
      setTimeout(() => confirm.classList.add("hidden"), 2000);
    } else {
      alert("❌ Failed to save feedback");
    }
  });
}

function clearInstructorFeedback(paperId) {
  document.getElementById("feedbackInput-" + paperId).value = "";
  submitInstructorFeedback(paperId);
}


function openSendGradesModal() {
  document.getElementById("sendGradesModal").classList.remove("hidden");
  updateSelectedCount();
}

function closeSendGradesModal() {
  document.getElementById("sendGradesModal").classList.add("hidden");
}

function selectAllStudents() {
  document.querySelectorAll(".student-checkbox").forEach(cb => cb.checked = true);
  updateSelectedCount();
}

function deselectAllStudents() {
  document.querySelectorAll(".student-checkbox").forEach(cb => cb.checked = false);
  updateSelectedCount();
}

function updateSelectedCount() {
  const selected = document.querySelectorAll(".student-checkbox:checked").length;
  document.getElementById("selectedCount").innerText = selected;

  const sendButton = document.getElementById("sendGradesButton");
  if (sendButton) {
    sendButton.disabled = selected === 0;
  }
}

document.querySelectorAll(".student-checkbox").forEach(cb => {
  cb.addEventListener("change", updateSelectedCount);
});

document.querySelector("#sendGradesModal form").addEventListener("submit", function (e) {
  const selected = document.querySelectorAll(".student-checkbox:checked").length;
  if (selected === 0) {
    e.preventDefault();
    showToast("❌ Please select at least one student before sending.");
  }
});


let progressTotal = 0;
let progressDone = 0;

function showProgressModal(title = "Processing...", total = 1) {
  progressDone = 0;
  progressTotal = total;
  document.getElementById("progressTitle").textContent = title;
  document.getElementById("progressCount").textContent = `0 / ${total}`;
  document.getElementById("progressModal").classList.remove("hidden");
}

function updateProgressModal(done) {
  progressDone = done;
  document.getElementById("progressCount").textContent = `${done} / ${progressTotal}`;
  if (done >= progressTotal) {
    setTimeout(() => closeProgressModal(), 1000);
  }
}

function closeProgressModal() {
  document.getElementById("progressModal").classList.add("hidden");
}


let conflictQueue = [];
let conflictPapersMap = {};
let currentExamId = null;

let ocrStartTime;

function uploadPapers(files) {
  if (files.length === 0) return;

  ocrStartTime = performance.now();

  const formData = new FormData();
  for (let file of files) formData.append("student_papers", file);
  formData.append("csrfmiddlewaretoken", '{{ csrf_token }}');

  showProgressModal("Uploading Papers...", files.length);
  fetch("{% url 'exams:upload_student_paper' exam.id %}", {
    method: "POST",
    body: formData
  })
    .then(res => res.json())
    .then(data => {
      const ocrEndTime = performance.now();
      const ocrDuration = ((ocrEndTime - ocrStartTime) / 1000).toFixed(2);

      if (data.success) {
        showToast("✅ Upload complete!");

        if (data.conflicts) {
          conflictQueue = Object.entries(data.conflicts);
          conflictPapersMap = data.paper_ids_by_id;
          currentExamId = "{{ exam.id }}";
          showNextConflict();
          closeProgressModal();
          return;
        }

        let done = 0;
        data.results.forEach((result, i) => {
          setTimeout(() => {
            done++;
            updateProgressModal(done);
            if (done === data.total) {
              setTimeout(() => location.reload(), 1500);
            }
          }, i * 150);
        });
      } else {
        showToast("❌ Upload failed", 60000);
        closeProgressModal();
      }
    })
    .catch(() => {
      showToast("❌ Upload error", 60000);
      closeProgressModal();
    });
}


function showNameConflictModal(nameOptions, paperIds) {
  const modal = document.getElementById("nameConflictModal");
  const optionsList = document.getElementById("nameOptionsList");
  const papersInput = document.getElementById("conflictPaperIds");

  papersInput.value = paperIds.join(",");

  optionsList.innerHTML = "";
  nameOptions.forEach((name, idx) => {
    optionsList.innerHTML += `
      <div class="flex items-center gap-2 mb-2">
        <input type="radio" name="selected_name" id="name${idx}" value="${name}" class="text-blue-600">
        <label for="name${idx}" class="text-gray-700 text-sm">${name}</label>
      </div>
    `;
  });

  // Add "Other" custom name option
  optionsList.innerHTML += `
    <div class="flex items-center gap-2 mt-4">
      <input type="radio" name="selected_name" id="otherName" value="other" class="text-blue-600">
      <label for="otherName" class="text-gray-700 text-sm">Other (Custom Name)</label>
    </div>
  `;

  modal.classList.remove("hidden");
  bindCustomNameToggle();
}

function showNextConflict() {
  if (conflictQueue.length === 0) {
    conflictPapersMap = {};
    currentExamId = null;
    return;
  }

  const [studentId, names] = conflictQueue.shift();
  const paperIds = conflictPapersMap[studentId] || [];

  document.getElementById("conflictExamId").value = currentExamId;
  document.getElementById("conflictPaperIds").value = paperIds.join(",");

  const optionsList = document.getElementById("nameOptionsList");
  optionsList.innerHTML = "";

  names.forEach((name, index) => {
    const id = `option_${index}`;
    optionsList.innerHTML += `
      <div class="flex items-center gap-2">
        <input type="radio" id="${id}" name="selected_name" value="${name}" class="text-blue-600">
        <label for="${id}" class="text-sm text-gray-800">${name}</label>
      </div>
    `;
  });

  optionsList.innerHTML += `
    <div class="flex items-center gap-2 mt-2">
      <input type="radio" id="option_other" name="selected_name" value="other" class="text-blue-600">
      <label for="option_other" class="text-sm text-gray-800">Other (Custom Name)</label>
    </div>
  `;

  document.getElementById("nameConflictModal").classList.remove("hidden");
  bindCustomNameToggle();
}



let gradingStartTime;

function startGrading(button = null) {
  if (totalPapers === 0) return alert("⚠️ No student papers available.");

  gradingStartTime = performance.now();

  const mode = button?.dataset.mode || "";

  if (button) {
    button.disabled = true;
    button.classList.add("opacity-60", "cursor-not-allowed");
    button.classList.remove("hover:bg-blue-700");
  }

  showProgressModal("Grading Papers with AI...", totalPapers);

  fetch("{% url 'exams:grade_exam' exam.id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
      "X-Requested-With": "XMLHttpRequest",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ mode: mode })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        let done = 0;
        data.results.forEach((result, i) => {
          setTimeout(() => {
            done++;
            updateProgressModal(done);
            if (done === data.total) {
              const gradingEndTime = performance.now();
              const gradingDuration = ((gradingEndTime - gradingStartTime) / 1000).toFixed(2);
              showToast("✅ Grading complete!");
              setTimeout(() => location.reload(), 1500);
            }
          }, i * 150);
        });
      } else {
        showToast("❌ Grading failed", 60000);
        closeProgressModal();
        if (button) {
          button.disabled = false;
          button.classList.remove("opacity-60", "cursor-not-allowed");
          button.classList.add("hover:bg-blue-700");
        }
      }
    })
    .catch(() => {
      showToast("❌ Grading request failed", 60000);
      closeProgressModal();
      if (button) {
        button.disabled = false;
        button.classList.remove("opacity-60", "cursor-not-allowed");
        button.classList.add("hover:bg-blue-700");
      }
    });
}

function showToast(message = "Done!") {
  const toast = document.getElementById("toastSuccess");
  const messageBox = document.getElementById("toastMessage");
  messageBox.textContent = message;
  toast.classList.remove("hidden");
  toast.classList.add("opacity-100");

  setTimeout(() => {
    toast.classList.add("opacity-0");
    setTimeout(() => toast.classList.add("hidden"), 300);
  }, 2500);
}

document.addEventListener("DOMContentLoaded", function () {
    const rawData = JSON.parse('{{ grade_chart_data|escapejs }}');

    const labels = rawData.map(d => d.name);
    const scores = rawData.map(d => d.score);  
    const backgroundColors = rawData.map(scoreObj => {
        if (scoreObj.score >= 85) return "#16a34a";  // green
        if (scoreObj.score >= 60) return "#facc15";  // yellow
        return "#ef4444";                            // red
    });

    const ctx = document.getElementById("gradesDistributionChart").getContext("2d");

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Score',
                data: scores,
                backgroundColor: backgroundColors,
                borderRadius: 6,
                barThickness: 30
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 20 },
            plugins: {
                tooltip: {
                    backgroundColor: "#1C304F",
                    titleFont: { weight: 'bold' },
                    callbacks: {
                        label: ctx => `Score: ${ctx.parsed.y}`
                    }
                },
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: parseFloat("{{ exam.total_marks|default:100 }}"),
                    ticks: {
                        stepSize: 10,
                        color: "#1C304F",
                        font: { size: 12, weight: "500" }
                    },
                    title: {
                        display: true,
                        text: 'Score',
                        color: "#1C304F",
                        font: { weight: "bold", size: 14 }
                    },
                    grid: { color: "#E2E8F0" }
                },
                x: {
                    ticks: {
                        color: "#1C304F",
                        font: { size: 12, weight: "500" }
                    },
                    title: {
                        display: true,
                        text: 'Student',
                        color: "#1C304F",
                        font: { weight: "bold", size: 14 }
                    },
                    grid: { display: false }
                }
            }
        }
    });
});

let selectedPaperIds = [];

function mergeSelectedPapers() {
  selectedPaperIds = [...document.querySelectorAll(".merge-checkbox:checked")].map(cb => cb.value);

  if (selectedPaperIds.length < 2) {
    showToast("❌ Select at least 2 papers to merge.");
    return;
  }
  document.getElementById("confirmMergeModal").classList.remove("hidden");
}

function closeMergeModal() {
  document.getElementById("confirmMergeModal").classList.add("hidden");
}


function unmergePaper() {
  const selectedCheckboxes = [...document.querySelectorAll(".merge-checkbox:checked")];
  const uniqueStudentIds = [...new Set(selectedCheckboxes.map(cb => cb.dataset.studentId))];

  if (selectedCheckboxes.length === 0) {
    showToast("❌ Select at least 1 paper to unmerge.");
    return;
  }

  if (uniqueStudentIds.length !== 1) {
    showToast("❌ You can only unmerge papers with the SAME student ID.");
    return;
  }

  document.getElementById("confirmUnmergeModal").classList.remove("hidden");
}

function confirmUnmergeNow() {
  const selectedCheckboxes = [...document.querySelectorAll(".merge-checkbox:checked")];
  const studentId = selectedCheckboxes[0]?.dataset.studentId;
  const examId = document.getElementById("examPage").dataset.examId; // make sure this line exists

  if (!studentId) {
    showToast("❌ Cannot unmerge: missing student ID.");
    closeUnmergeModal();
    return;
  }

  fetch(`/exams/${examId}/unmerge-by-id/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": '{{ csrf_token }}',
    },
    body: JSON.stringify({ student_id: studentId })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast("✅ Unmerged successfully!");
      setTimeout(() => location.reload(), 1200);
    } else {
      showToast("❌ " + (data.error || "Failed to unmerge."));
    }
    closeUnmergeModal();
  })
  .catch(() => {
    showToast("❌ Error unmerging papers.");
    closeUnmergeModal();
  });
}


function closeUnmergeModal() {
  document.getElementById("confirmUnmergeModal").classList.add("hidden");
}

function confirmMergeNow() {
  if (selectedPaperIds.length < 2) {
    showToast("❌ Select at least 2 papers to merge.");
    return;
  }

  fetch("{% url 'exams:merge_papers_by_id' exam.id %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "X-CSRFToken": '{{ csrf_token }}',
    },
    body: new URLSearchParams(selectedPaperIds.map(id => ["paper_ids", id]))
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast("✅ Papers merged successfully!");
      setTimeout(() => location.reload(), 1200);
    } else if (data.name_conflict) {
      showNameConflictModal(data.name_options, data.paper_ids);
    } else {
      showToast("❌ " + (data.error || "Failed to merge papers."));
    }
    closeMergeModal();
  })
  .catch(() => {
    showToast("❌ Error merging papers.");
    closeMergeModal();
  });
}

function closeNameConflictModal() {
  document.getElementById("nameConflictModal").classList.add("hidden");
}

document.getElementById("resolveNameForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const examId = document.getElementById("conflictExamId").value;
  const paperIds = document.getElementById("conflictPaperIds").value.split(",");

  let selectedName = document.querySelector("input[name='selected_name']:checked")?.value;
  const customName = document.getElementById("customNameInput").value.trim();

  if (!selectedName && !customName) {
    alert("❌ Please select or enter a name.");
    return;
  }

  if (selectedName === "other") {
    if (!customName) {
      alert("❌ Please enter a custom name.");
      return;
    }
    selectedName = customName;  
  }

  fetch(`/exams/${examId}/merge/resolve-name/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": '{{ csrf_token }}',
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams([
      ...paperIds.map(id => ['paper_ids[]', id]),
      ['resolved_name', selectedName]  
    ])
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) location.reload();
    else showToast("❌ " + data.error);
  });
});

document.addEventListener("DOMContentLoaded", function () {
  document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".override-input").forEach(input => {
    input.addEventListener("input", function () {
      const val = parseFloat(this.value);
      const max = parseFloat(this.closest(".override-form").dataset.total);
      const errorMsg = this.closest(".override-form").querySelector(".error-message");

      if (isNaN(val) || val > max || val < 0) {
        errorMsg.classList.remove("hidden");
      } else {
        errorMsg.classList.add("hidden");
      }
    });
  });
});

  document.querySelectorAll("input[name='selected_name']").forEach(radio => {
    radio.addEventListener("change", function () {
      const customInput = document.getElementById("customNameInput");
      if (this.value.toLowerCase() === "other") {
        customInput.disabled = false;
        customInput.parentElement.classList.remove("hidden"); // show input
        customInput.focus();
      } else {
        customInput.disabled = true;
        customInput.parentElement.classList.add("hidden"); // hide input
        customInput.value = "";
      }
    });
  });

  // ✅ Initially hide the input field
  const inputContainer = document.getElementById("customNameInput")?.parentElement;
  if (inputContainer) {
    inputContainer.classList.add("hidden");
  }
});

function bindCustomNameToggle() {
  document.querySelectorAll("input[name='selected_name']").forEach(radio => {
    radio.addEventListener("change", () => {
      const customInput = document.getElementById("customNameInput");
      if (radio.value === "other") {
        customInput.disabled = false;
        customInput.parentElement.classList.remove("hidden");
        customInput.focus();
      } else {
        customInput.disabled = true;
        customInput.parentElement.classList.add("hidden");
        customInput.value = "";
      }
    });
  });
}

document.addEventListener("scroll", () => {
  const table = document.getElementById("gradesTable");
  const toolbar = document.getElementById("floatingToolbar");

  if (!table || !toolbar) return;

  const rect = table.getBoundingClientRect();
  const inView = rect.top < 150 && rect.bottom > 200;

  if (inView) {
    toolbar.classList.remove("hidden");
  } else {
    toolbar.classList.add("hidden");
  }
});

function updateMergeFabVisibility() {
  const anyChecked = [...document.querySelectorAll(".merge-checkbox")].some(cb => cb.checked);
  document.getElementById("mergeFab").classList.toggle("hidden", !anyChecked);
}

document.querySelectorAll(".merge-checkbox").forEach(cb => {
  cb.addEventListener("change", updateMergeFabVisibility);
});


function applyBadgeFilter() {
  const selected = document.getElementById("badgeFilterDropdown").value.toLowerCase();

  document.querySelectorAll("#gradesTable tbody tr").forEach(row => {
    const badges = Array.from(row.querySelectorAll("td .badge-filtered span"))
                        .map(badge => badge.innerText.trim().toLowerCase());

    if (selected === "all" || badges.includes(selected)) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
}

const feedbackMap = JSON.parse('{{ paper_data_json|safe|escapejs }}');

function openFeedbackModal(paperId) {
  const paper = feedbackMap.find(p => p.id == paperId);
  if (!paper) return;

  const feedbackContent = document.getElementById("feedbackContent");
  const modal = document.getElementById("feedbackModal");

  const blocks = paper.graded_questions.map(q => {
    let borderColor = "border-yellow-500";
    if (q.type === "MCQ") borderColor = "border-blue-500";
    else if (q.type === "TF") borderColor = "border-green-500";

    return `
      <div class="bg-gray-50 border-l-4 p-4 rounded-lg shadow-md ${borderColor}">
        <p class="text-md font-semibold text-gray-800"> ${q.question}</p>
        <p class="mt-2 text-gray-700"><strong>AI Feedback:</strong><br><span class="whitespace-pre-line">${q.feedback}</span></p>
      </div>
    `;
  }).join("");

  feedbackContent.innerHTML = blocks;
  modal.classList.remove("hidden");
}

function closeFeedbackModal() {
  document.getElementById("feedbackModal").classList.add("hidden");
}

function openDeleteAllModal() {
    document.getElementById('deleteAllModal').classList.remove('hidden');
  }

  function closeDeleteAllModal() {
    document.getElementById('deleteAllModal').classList.add('hidden');
  }

  document.getElementById("deleteAllForm").addEventListener("submit", function (e) {
  e.preventDefault();

  fetch("{% url 'exams:delete_all_papers' exam.id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": '{{ csrf_token }}',
      "X-Requested-With": "XMLHttpRequest"
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      closeDeleteAllModal();
      showToast("✅ " + data.message);

      const paperList = document.querySelector(".student-papers-container");
      if (paperList) {
        paperList.innerHTML = `
          <p class="text-sm text-gray-500">No student papers uploaded yet.</p>
        `;
      }

      const rows = document.querySelectorAll("#gradesTable tbody tr");
      rows.forEach(row => row.remove());
    } else {
      showToast("❌ " + (data.error || "Failed to delete papers."));
    }
  });
});

</script>

<script>
    const totalPapers = parseInt("{{ student_papers|length|default:0 }}");
  </script>

{% endblock %}
